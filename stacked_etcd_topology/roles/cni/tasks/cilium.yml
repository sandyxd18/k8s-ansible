---
- name: Get Cilium CLI stable version
  ansible.builtin.uri:
    url: https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt
    return_content: yes
  register: cilium_cli_version

- name: Set Cilium CLI architecture
  ansible.builtin.set_fact:
    cli_arch: >-
      {{ 'arm64' if ansible_architecture in ['aarch64', 'arm64'] else 'amd64' }}

- name: Download Cilium CLI
  ansible.builtin.get_url:
    url: "https://github.com/cilium/cilium-cli/releases/download/{{ cilium_cli_version.content | trim }}/cilium-linux-{{ cli_arch }}.tar.gz"
    dest: "/tmp/cilium-linux-{{ cli_arch }}.tar.gz"
    mode: '0644'

- name: Download Cilium CLI checksum
  ansible.builtin.get_url:
    url: "https://github.com/cilium/cilium-cli/releases/download/{{ cilium_cli_version.content | trim }}/cilium-linux-{{ cli_arch }}.tar.gz.sha256sum"
    dest: "/tmp/cilium-linux-{{ cli_arch }}.tar.gz.sha256sum"
    mode: '0644'

- name: Verify Cilium CLI checksum
  ansible.builtin.command:
    cmd: >
      sha256sum --check cilium-linux-{{ cli_arch }}.tar.gz.sha256sum
  args:
    chdir: /tmp
  register: checksum_result
  changed_when: false

- name: Extract Cilium CLI to /usr/local/bin
  ansible.builtin.unarchive:
    src: "/tmp/cilium-linux-{{ cli_arch }}.tar.gz"
    dest: /usr/local/bin
    remote_src: yes
    mode: '0755'

- name: Remove downloaded files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "/tmp/cilium-linux-{{ cli_arch }}.tar.gz"
    - "/tmp/cilium-linux-{{ cli_arch }}.tar.gz.sha256sum"

- name: Install Cilium CNI
  shell: |
    cilium install --version {{ cilium_version }}
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

- name: Wait for Cilium to be ready
  shell: cilium status --wait
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  ignore_errors: yes