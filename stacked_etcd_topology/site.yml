---
- name: Setup HAProxy Load Balancer
  hosts: load_balancers
  gather_facts: true
  roles:
    - lb

- name: Prepare all nodes
  hosts: k8s_cluster
  gather_facts: true
  roles:
    - common
    - container-runtime
    - kubernetes
  
- name: Setup Kubernetes Master
  hosts: masters
  gather_facts: true
  roles:
    - master
    - cni
  when: inventory_hostname == groups['masters'][0]

- name: Join Master Nodes
  hosts: masters
  gather_facts: true
  roles:
    - master-join
  when: inventory_hostname != groups['masters'][0]

- name: Join Worker Nodes
  hosts: workers
  gather_facts: true
  roles:
    - worker

- name: Deploy Addons
  hosts: masters
  gather_facts: true
  roles:
    - addons
  when: inventory_hostname == groups['masters'][0]