---
- name: Download Metrics Server manifest
  get_url:
    url: "https://github.com/kubernetes-sigs/metrics-server/releases/download/{{ addons.metrics_server.version }}/components.yaml"
    dest: /tmp/metrics-server.yaml
    mode: '0644'

- name: Patch Metrics Server for insecure TLS (for testing environments)
  shell: |
    sed -i 's/- args:/- args:\n        - --kubelet-insecure-tls/' /tmp/metrics-server.yaml

- name: Apply Metrics Server
  shell: kubectl apply -f /tmp/metrics-server.yaml
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

- name: Wait for Metrics Server to be ready
  shell: kubectl wait --namespace kube-system --for=condition=ready pod --selector=k8s-app=metrics-server --timeout=300s
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  ignore_errors: yes
